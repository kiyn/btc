<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calcolo Percentuale</title>
  <style>
    /* Impostazioni globali per tema scuro e background nero */
    body {
      background-color: #000;
      color: #fff;
      font-family: sans-serif;
      margin: 0;
      padding: 1em;
    }
    .container {
      max-width: 480px; /* dimensione adatta allo smartphone */
      margin: 0 auto;
    }
    h1 {
      text-align: center;
      margin-bottom: 1em;
    }
    /* Layout a righe: etichetta a sinistra, campo a destra con bottoni */
    .row {
      display: flex;
      align-items: center;
      margin-bottom: 1em;
    }
    .label {
      flex: 0 0 40%;
      padding-right: 0.5em;
      font-size: 1em;
    }
    .input-container {
      flex: 1;
      display: flex;
      align-items: center;
    }
    input {
      flex: 1;
      padding: 0.5em;
      background-color: #222;
      border: 1px solid #444;
      color: #fff;
      font-size: 1em;
      border-radius: 4px;
    }
    input[readonly] {
      opacity: 0.8;
    }
    button {
      margin-left: 0.5em;
      background: none;
      border: none;
      color: #fff;
      font-size: 1.2em;
      cursor: pointer;
    }
    button:focus {
      outline: none;
    }
    /* Effetto blink: il campo lampeggia per 0.5 secondi dopo copia */
    .blink {
      animation: blink-animation 0.5s;
    }
    @keyframes blink-animation {
      0% { background-color: #444; }
      100% { background-color: transparent; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Calcolo Percentuale</h1>
    <!-- Riga "Valore iniziale" -->
    <div class="row">
      <div class="label">Valore iniziale</div>
      <div class="input-container">
        <input id="iniziale" type="number" step="any" placeholder="" inputmode="decimal">
        <!-- Bottone cancella (icona Unicode ❌ – U+274C) -->
        <button class="clear" data-target="iniziale">&#x274C;</button>
        <!-- Bottone copia (icona Unicode 📋 – U+1F4CB) -->
        <button class="copy" data-target="iniziale">&#x1F4CB;</button>
      </div>
    </div>
    <!-- Riga "Tasso %" -->
    <div class="row">
      <div class="label">Tasso %</div>
      <div class="input-container">
        <input id="tasso" type="number" step="any" placeholder="" inputmode="decimal">
        <button class="clear" data-target="tasso">&#x274C;</button>
        <button class="copy" data-target="tasso">&#x1F4CB;</button>
      </div>
    </div>
    <!-- Riga "Valore %" (calcolato) -->
    <div class="row">
      <div class="label">Valore %</div>
      <div class="input-container">
        <input id="valorePerc" type="number" step="any" placeholder="" readonly inputmode="decimal">
        <button class="clear" data-target="valorePerc">&#x274C;</button>
        <button class="copy" data-target="valorePerc">&#x1F4CB;</button>
      </div>
    </div>
    <!-- Riga "Valore Finale + Tasso" -->
    <div class="row">
      <div class="label">Valore Finale + Tasso</div>
      <div class="input-container">
        <input id="finalPlus" type="number" step="any" placeholder="" inputmode="decimal">
        <button class="clear" data-target="finalPlus">&#x274C;</button>
        <button class="copy" data-target="finalPlus">&#x1F4CB;</button>
      </div>
    </div>
    <!-- Riga "Valore Finale - Tasso" -->
    <div class="row">
      <div class="label">Valore Finale - Tasso</div>
      <div class="input-container">
        <input id="finalMinus" type="number" step="any" placeholder="" inputmode="decimal">
        <button class="clear" data-target="finalMinus">&#x274C;</button>
        <button class="copy" data-target="finalMinus">&#x1F4CB;</button>
      </div>
    </div>
  </div>

  <script>
    /******************
     * Logica JavaScript
     ******************/
    // Flag per evitare cicli durante l'aggiornamento
    let isUpdating = false;
    // Memorizziamo l'ultimo aggiornamento (timestamp) per ciascun campo opzionale
    let lastModified = {
      "tasso": 0,
      "finalPlus": 0,
      "finalMinus": 0
    };

    /**
     * La funzione recalc() esegue i calcoli dinamicamente.
     *
     * Le modalità sono:
     *  • Se "Valore iniziale" e "Tasso" sono forniti: 
     *      - Valore % = iniziale * (Tasso/100)
     *      - Finale + = iniziale + Valore %
     *      - Finale - = iniziale - Valore %
     *
     *  • Se "Valore iniziale" e "Valore Finale + Tasso" sono forniti:
     *      - Tasso = ((FinalPlus - iniziale) / iniziale) * 100
     *      - Valore % = iniziale * (Tasso/100)
     *      - Il campo "Finale - Tasso" viene lasciato vuoto.
     *
     *  • Se "Valore iniziale" e "Valore Finale - Tasso" sono forniti:
     *      - Tasso = ((iniziale - FinalMinus) / iniziale) * 100
     *      - Valore % = iniziale * (Tasso/100)
     *      - Il campo "Finale + Tasso" viene lasciato vuoto.
     */
    function recalc() {
      if (isUpdating) return;
      isUpdating = true;
      
      // Legge il Valore Iniziale
      const inizialeInput = document.getElementById('iniziale');
      let iniziale = parseFloat(inizialeInput.value);
      if (isNaN(iniziale)) {
        // Se il campo iniziale non è valido, puliamo tutti gli altri campi
        document.getElementById('tasso').value = "";
        document.getElementById('valorePerc').value = "";
        document.getElementById('finalPlus').value = "";
        document.getElementById('finalMinus').value = "";
        isUpdating = false;
        return;
      }
      
      // Riferimenti ai campi opzionali
      const tassoInput = document.getElementById('tasso');
      const finalPlusInput = document.getElementById('finalPlus');
      const finalMinusInput = document.getElementById('finalMinus');
      const valorePercInput = document.getElementById('valorePerc');
      
      let tassoStr = tassoInput.value;
      let finalPlusStr = finalPlusInput.value;
      let finalMinusStr = finalMinusInput.value;
      
      let tassoVal = parseFloat(tassoStr);
      let finalPlusVal = parseFloat(finalPlusStr);
      let finalMinusVal = parseFloat(finalMinusStr);
      
      // Verifichiamo se ciascun campo contiene un numero valido
      let hasTasso = tassoStr.trim() !== "" && !isNaN(tassoVal);
      let hasFinalPlus = finalPlusStr.trim() !== "" && !isNaN(finalPlusVal);
      let hasFinalMinus = finalMinusStr.trim() !== "" && !isNaN(finalMinusVal);
      
      // Determiniamo quale campo opzionale è l'input "fonte"
      let candidate = [];
      if (hasTasso) candidate.push({ field: "tasso", time: lastModified["tasso"] });
      if (hasFinalPlus) candidate.push({ field: "finalPlus", time: lastModified["finalPlus"] });
      if (hasFinalMinus) candidate.push({ field: "finalMinus", time: lastModified["finalMinus"] });
      
      if (candidate.length === 0) {
        // Nessun campo opzionale ha un valore: puliamo tutti gli output
        tassoInput.value = "";
        valorePercInput.value = "";
        finalPlusInput.value = "";
        finalMinusInput.value = "";
        isUpdating = false;
        return;
      }
      
      // Scegliamo il campo con l'ultimo aggiornamento
      candidate.sort((a, b) => b.time - a.time);
      let source = candidate[0].field;
      
      let computedT, computedValPerc, computedFinalPlus, computedFinalMinus;
      
      if (source === "tasso") {
        // Caso 1: Valore iniziale + Tasso
        computedT = tassoVal;
        computedValPerc = iniziale * computedT / 100;
        computedFinalPlus = iniziale + computedValPerc;
        computedFinalMinus = iniziale - computedValPerc;
        // Aggiorniamo i campi calcolati
        valorePercInput.value = computedValPerc;
        finalPlusInput.value = computedFinalPlus;
        finalMinusInput.value = computedFinalMinus;
      } else if (source === "finalPlus") {
        // Caso 2: Valore iniziale + Valore Finale + Tasso
        computedT = ((finalPlusVal - iniziale) / iniziale) * 100;
        computedValPerc = iniziale * computedT / 100;
        // Aggiorniamo Tasso e Valore %
        tassoInput.value = computedT;
        valorePercInput.value = computedValPerc;
        // Manteniamo "Finale + Tasso" e puliamo "Finale - Tasso"
        finalMinusInput.value = "";
      } else if (source === "finalMinus") {
        // Caso 3: Valore iniziale + Valore Finale - Tasso
        computedT = ((iniziale - finalMinusVal) / iniziale) * 100;
        computedValPerc = iniziale * computedT / 100;
        tassoInput.value = computedT;
        valorePercInput.value = computedValPerc;
        // Manteniamo "Finale - Tasso" e puliamo "Finale + Tasso"
        finalPlusInput.value = "";
      }
      
      isUpdating = false;
    }
    
    // Gestione degli eventi "input" sui campi (aggiornamento dinamico)
    document.getElementById('iniziale').addEventListener('input', recalc);
    document.getElementById('tasso').addEventListener('input', function() {
      lastModified["tasso"] = Date.now();
      recalc();
    });
    document.getElementById('finalPlus').addEventListener('input', function() {
      lastModified["finalPlus"] = Date.now();
      recalc();
    });
    document.getElementById('finalMinus').addEventListener('input', function() {
      lastModified["finalMinus"] = Date.now();
      recalc();
    });
    
    // Gestione dei bottoni "cancella"
    document.querySelectorAll('button.clear').forEach(button => {
      button.addEventListener('click', function() {
        const targetId = this.getAttribute('data-target');
        const targetInput = document.getElementById(targetId);
        targetInput.value = "";
        targetInput.focus();
        if (lastModified.hasOwnProperty(targetId)) {
          lastModified[targetId] = 0;
        }
        recalc();
      });
    });
    
    // Gestione dei bottoni "copia"
    document.querySelectorAll('button.copy').forEach(button => {
      button.addEventListener('click', function() {
        const targetId = this.getAttribute('data-target');
        const targetInput = document.getElementById(targetId);
        if (targetInput.value.trim() !== "") {
          navigator.clipboard.writeText(targetInput.value).then(() => {
            // Aggiunge la classe per far lampeggiare il campo per 0.5 secondi
            targetInput.classList.add('blink');
            setTimeout(() => {
              targetInput.classList.remove('blink');
            }, 500);
          }).catch(err => {
            console.error('Errore nella copia: ', err);
          });
        }
      });
    });
  </script>
</body>
</html>
