<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calcolo Percentuale</title>
  <style>
    /* Blocca l'altezza della pagina e disabilita lo scroll */
    html, body {
      height: 100%;
      overflow: hidden;
    }
    /* Impostazioni globali per tema scuro e background nero */
    body {
      background-color: #000;
      color: #fff;
      font-family: sans-serif;
      margin: 0;
      padding: 1em;
    }
    .container {
      max-width: 480px; /* dimensione adatta allo smartphone */
      margin: 0 auto;
    }
    h1 {
      text-align: center;
      margin-bottom: 1em;
    }
    /* Layout a righe: etichetta a sinistra, campo a destra con bottoni */
    .row {
      display: flex;
      align-items: center;
      margin-bottom: 0.5em; /* spazio ridotto tra le righe */
    }
    .label {
      flex: 0 0 40%;
      padding-right: 0.5em;
      font-size: 1em;
    }
    .input-container {
      flex: 1;
      display: flex;
      align-items: center;
    }
    /* Riduzione della larghezza del campo di input del 20% */
    input {
      width: 80%;
      padding: 0.5em;
      background-color: #222;
      border: 1px solid #444;
      color: #fff;
      font-size: 1em;
      border-radius: 4px;
    }
    input[readonly] {
      opacity: 0.8;
    }
    /* Spazio ridotto tra bottoni */
    button {
      margin-left: 0.2em; /* ridotto da 0.5em */
      background: none;
      border: none;
      color: #fff;
      font-size: 1.2em;
      cursor: pointer;
    }
    button:focus {
      outline: none;
    }
    /* Pulsante "Reset" (Cancella Tutto) centrato in basso */
    #clearAllBtn {
      font-size: 1.4em;
      padding: 0.5em 1em;
      margin-top: 1em;
    }
    /* Effetto blink: il campo lampeggia per 1 secondo dopo copia */
    .blink {
      animation: blink-animation 1s;
    }
    @keyframes blink-animation {
      0% { background-color: #444; }
      100% { background-color: transparent; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Calcolo Percentuale</h1>
    <!-- Riga "Valore iniziale" -->
    <div class="row">
      <div class="label">Valore iniziale</div>
      <div class="input-container">
        <input id="iniziale" type="tel" placeholder="">
        <button class="clear" data-target="iniziale">&#x274C;</button>
        <button class="copy" data-target="iniziale">&#x1F4CB;</button>
      </div>
    </div>
    <!-- Riga "%" (ex "Tasso %") -->
    <div class="row">
      <div class="label">%</div>
      <div class="input-container">
        <input id="tasso" type="tel" placeholder="">
        <button class="clear" data-target="tasso">&#x274C;</button>
        <button class="copy" data-target="tasso">&#x1F4CB;</button>
      </div>
    </div>
    <!-- Riga "Differenza" (ex "Valore %") -->
    <div class="row">
      <div class="label">Differenza</div>
      <div class="input-container">
        <input id="valorePerc" type="tel" placeholder="" readonly>
        <button class="clear" data-target="valorePerc">&#x274C;</button>
        <button class="copy" data-target="valorePerc">&#x1F4CB;</button>
      </div>
    </div>
    <!-- Riga "Valore Finale +" (ex "Valore Finale + Tasso") -->
    <div class="row">
      <div class="label">Valore Finale +</div>
      <div class="input-container">
        <input id="finalPlus" type="tel" placeholder="">
        <button class="clear" data-target="finalPlus">&#x274C;</button>
        <button class="copy" data-target="finalPlus">&#x1F4CB;</button>
      </div>
    </div>
    <!-- Riga "Valore Finale -" (ex "Valore Finale - Tasso") -->
    <div class="row">
      <div class="label">Valore Finale -</div>
      <div class="input-container">
        <input id="finalMinus" type="tel" placeholder="">
        <button class="clear" data-target="finalMinus">&#x274C;</button>
        <button class="copy" data-target="finalMinus">&#x1F4CB;</button>
      </div>
    </div>
    <!-- Riga per il tasto "Reset" (Cancella Tutto) -->
    <div class="row">
      <div style="width: 100%; text-align: center;">
        <button id="clearAllBtn" title="Cancella tutti i campi">&#x274C; Reset</button>
      </div>
    </div>
  </div>

  <script>
    /******************
     * Logica JavaScript
     ******************/

    // Funzione di arrotondamento a due cifre decimali
    function round2(value) {
      return Number(value.toFixed(2));
    }

    // Flag per evitare cicli durante l'aggiornamento
    let isUpdating = false;

    // Memorizziamo l'ultimo aggiornamento (timestamp) per ciascun campo opzionale
    let lastModified = {
      tasso: 0,
      finalPlus: 0,
      finalMinus: 0
    };

    // Flag per "bloccare" i campi finali se cancellati manualmente
    let locked = {
      finalPlus: false,
      finalMinus: false
    };

    /**
     * La funzione recalc() esegue i calcoli dinamicamente.
     *
     * Le modalità sono:
     *  • Se "Valore iniziale" e "%" sono forniti: 
     *      - Differenza = iniziale * (%/100)
     *      - Valore Finale + = iniziale + Differenza
     *      - Valore Finale - = iniziale - Differenza
     *
     *  • Se "Valore iniziale" e "Valore Finale +" sono forniti:
     *      - % = ((Valore Finale + - iniziale) / iniziale) * 100
     *      - Differenza = iniziale * (%/100)
     *      - Il campo "Valore Finale -" viene lasciato vuoto.
     *
     *  • Se "Valore iniziale" e "Valore Finale -" sono forniti:
     *      - % = ((iniziale - Valore Finale -) / iniziale) * 100
     *      - Differenza = iniziale * (%/100)
     *      - Il campo "Valore Finale +" viene lasciato vuoto.
     */
    function recalc() {
      if (isUpdating) return;
      isUpdating = true;
      
      // Legge il Valore Iniziale
      const inizialeInput = document.getElementById('iniziale');
      let iniziale = parseFloat(inizialeInput.value);
      if (isNaN(iniziale)) {
        // Se il campo iniziale non è valido, puliamo tutti gli altri campi
        document.getElementById('tasso').value = "";
        document.getElementById('valorePerc').value = "";
        document.getElementById('finalPlus').value = "";
        document.getElementById('finalMinus').value = "";
        isUpdating = false;
        return;
      }
      
      // Riferimenti ai campi opzionali
      const tassoInput = document.getElementById('tasso');
      const finalPlusInput = document.getElementById('finalPlus');
      const finalMinusInput = document.getElementById('finalMinus');
      const valorePercInput = document.getElementById('valorePerc');
      
      let tassoStr = tassoInput.value;
      let finalPlusStr = finalPlusInput.value;
      let finalMinusStr = finalMinusInput.value;
      
      let tassoVal = parseFloat(tassoStr);
      let finalPlusVal = parseFloat(finalPlusStr);
      let finalMinusVal = parseFloat(finalMinusStr);
      
      // Verifica se ciascun campo contiene un numero valido
      let hasTasso = tassoStr.trim() !== "" && !isNaN(tassoVal);
      let hasFinalPlus = finalPlusStr.trim() !== "" && !isNaN(finalPlusVal);
      let hasFinalMinus = finalMinusStr.trim() !== "" && !isNaN(finalMinusVal);
      
      // Determiniamo quale campo opzionale è l'input "fonte"
      let candidate = [];
      if (hasTasso) candidate.push({ field: "tasso", time: lastModified["tasso"] });
      if (hasFinalPlus) candidate.push({ field: "finalPlus", time: lastModified["finalPlus"] });
      if (hasFinalMinus) candidate.push({ field: "finalMinus", time: lastModified["finalMinus"] });
      
      if (candidate.length === 0) {
        // Nessun campo opzionale ha un valore: puliamo tutti gli output
        tassoInput.value = "";
        valorePercInput.value = "";
        if (!locked.finalPlus) finalPlusInput.value = "";
        if (!locked.finalMinus) finalMinusInput.value = "";
        isUpdating = false;
        return;
      }
      
      // Scegliamo il campo con l'ultimo aggiornamento
      candidate.sort((a, b) => b.time - a.time);
      let source = candidate[0].field;
      
      let computedT, computedValPerc, computedFinalPlus, computedFinalMinus;
      
      if (source === "tasso") {
        // Caso 1: Valore iniziale + % 
        computedT = tassoVal;
        computedValPerc = round2(iniziale * computedT / 100);
        computedFinalPlus = round2(iniziale + computedValPerc);
        computedFinalMinus = round2(iniziale - computedValPerc);
        valorePercInput.value = computedValPerc;
        if (!locked.finalPlus) {
          finalPlusInput.value = computedFinalPlus;
        } else {
          finalPlusInput.value = "";
        }
        if (!locked.finalMinus) {
          finalMinusInput.value = computedFinalMinus;
        } else {
          finalMinusInput.value = "";
        }
      } else if (source === "finalPlus") {
        // Caso 2: Valore iniziale + Valore Finale +
        computedT = ((finalPlusVal - iniziale) / iniziale) * 100;
        computedT = round2(computedT);
        computedValPerc = round2(iniziale * computedT / 100);
        tassoInput.value = computedT;
        valorePercInput.value = computedValPerc;
        finalMinusInput.value = "";
      } else if (source === "finalMinus") {
        // Caso 3: Valore iniziale + Valore Finale -
        computedT = ((iniziale - finalMinusVal) / iniziale) * 100;
        computedT = round2(computedT);
        computedValPerc = round2(iniziale * computedT / 100);
        tassoInput.value = computedT;
        valorePercInput.value = computedValPerc;
        finalPlusInput.value = "";
      }
      
      isUpdating = false;
    }
    
    // Gestione degli eventi "input" sui campi (aggiornamento dinamico)
    document.getElementById('iniziale').addEventListener('input', recalc);
    document.getElementById('tasso').addEventListener('input', function() {
      lastModified["tasso"] = Date.now();
      recalc();
    });
    document.getElementById('finalPlus').addEventListener('input', function() {
      locked.finalPlus = false;
      lastModified["finalPlus"] = Date.now();
      recalc();
    });
    document.getElementById('finalMinus').addEventListener('input', function() {
      locked.finalMinus = false;
      lastModified["finalMinus"] = Date.now();
      recalc();
    });
    
    // Gestione dei bottoni "cancella" accanto a ciascun campo
    document.querySelectorAll('button.clear').forEach(button => {
      button.addEventListener('click', function() {
        const targetId = this.getAttribute('data-target');
        const targetInput = document.getElementById(targetId);
        targetInput.value = "";
        targetInput.focus();
        if (lastModified.hasOwnProperty(targetId)) {
          lastModified[targetId] = 0;
        }
        if (targetId === "finalPlus" || targetId === "finalMinus") {
          locked[targetId] = true;
        }
        recalc();
      });
    });
    
    // Gestione dei bottoni "copia"
    document.querySelectorAll('button.copy').forEach(button => {
      button.addEventListener('click', function() {
        const targetId = this.getAttribute('data-target');
        const targetInput = document.getElementById(targetId);
        if (targetInput.value.trim() !== "") {
          navigator.clipboard.writeText(targetInput.value).then(() => {
            targetInput.classList.add('blink');
            setTimeout(() => {
              targetInput.classList.remove('blink');
            }, 1000);
          }).catch(err => {
            console.error('Errore nella copia: ', err);
          });
        }
      });
    });

    // Gestione del tasto "Reset" (Cancella Tutto)
    document.getElementById('clearAllBtn').addEventListener('click', function() {
      document.getElementById('iniziale').value = "";
      document.getElementById('tasso').value = "";
      document.getElementById('valorePerc').value = "";
      document.getElementById('finalPlus').value = "";
      document.getElementById('finalMinus').value = "";
      lastModified.tasso = 0;
      lastModified.finalPlus = 0;
      lastModified.finalMinus = 0;
      locked.finalPlus = false;
      locked.finalMinus = false;
      recalc();
    });
  </script>
</body>
</html>
